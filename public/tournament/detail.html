<!DOCTYPE html>
<html lang="ja">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="icon" type="image/png" href="/img/kakomimasu-icon.png">
    <link rel="apple-touch-icon" href="/img/kakomimasu-icon.png">

    <title>大会詳細 - 囲みマス</title>
  </head>

  <body>
    <header id="header"></header>
    <main id="main">
      <h1 id="title">大会詳細</h1>
      <a class="button" href="index.html">大会一覧に戻る</a>

      <section class="separation">
        <h2>基本情報</h2>

        <h3>大会名</h3>
        <div class="name">{{tournament.name}}</div>
        <h3>主催</h3>
        <div class="organizer">{{tournament.organizer}}</div>
        <h3>大会ID</h3>
        <div class="id">{{tournament.id}}</div>
        <h3>試合形式</h3>
        <div class="type">{{getType(tournament.type)}}</div>
        <h3>備考</h3>
        <div class="remarks">{{tournament.remarks}}</div>
      </section>

      <section class="separation">
        <h2>試合</h2>
        <h3 class="heading">試合形式</h3>
        <div class="type">{{getType(tournament.type)}}</div>
        <form id="add-user-form">
          <div>
            <label for="user-id">ユーザ追加</label>
            <input type="text" id="user-id" autocomplete="on" list="user-list">
            <datalist id="user-list">
              <option v-for="s in searchUserOptions" :value="s.name">{{s.id}}</option>
            </datalist>
            <input type="submit" value="追加">
          </div>
        </form>

        <div v-if="tournament.type === 'round-robin'">
          <table id="round-robin-table">
            <tr>
              <th></th>
              <th v-for="(user ,x) in tournament.users">
                {{user.name}}
              </th>
            </tr>
            <tr v-for="(user,y) in tournament.users">
              <th>{{user.name}}</th>
              <td v-for="(column ,x) in tournament.users">
                <div v-if="x === y">\</div>
                <div v-else-if="getResult(y,x)">
                  <div>{{getResult(y,x).resultText}}</div>
                  <div>{{getResult(y,x).pointText}}</div>
                  <a :href="getResult(y,x).url">ゲーム詳細へ</a>
                </div>
                <div v-else>
                  <button @click="gameCreate(y,x)">作成</button>
                </div>
              </td>
            </tr>
          </table>
        </div>
        <canvas id="table"></canvas>

      </section>

    </main>
    <footer id="footer"></footer>

    <script type="module">
      import Vue from 'https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.esm.browser.js'
      import { getTournament, addTournamentUser, getUser, searchUser, getGame } from "/js/api-util.js";
      import * as util from "/js/util.js";

      const mainVue = new Vue({
        el: "#main",
        data: {
          tournament: {},
          searchUserOptions: [],
        },
        created: async function () {
          const query = util.getUrlQueries();
          const tournament = await getTournament(query.id);
          this.update(tournament);
        },
        methods: {
          async update(tournament) {
            tournament.users = await Promise.all(tournament.users.map(async (e) => await getUser(e)));
            tournament.games = await Promise.all(tournament.gameIds.map(async (e) => await getGame(e)));
            console.log(tournament);
            this.tournament = tournament;
            if (tournament.type === "knockout") {
              const users = tournament.users;
              const canvas = document.getElementById("table");
              const ctx = canvas.getContext("2d");
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              users.forEach((e, i) => {
                ctx.font = "20px sans-serif";
                ctx.textBaseline = "top";
                console.log(e.name);
                ctx.fillText(e.screenName, 0, i * 30, 100);
                ctx.beginPath();
                ctx.moveTo(100, i * 30 + 10);
                ctx.lineTo(110, i * 30 + 10)
                ctx.stroke();
              });
            }
          },
          getType(type) {
            if (type === "round-robin") return "総当たり戦";
            else if (type === "knockout") return "勝ち残り戦";
          },
          getResult(m, o) {
            const users = this.tournament.users;
            const games = this.tournament.games;
            console.log(users, games);
            const game = games.find(e =>
              e.reservedUsers[0] === users[m].id ||
              e.reservedUsers[1] === users[o].id &&
              e.reservedUsers[0] === users[o].id ||
              e.reservedUsers[1] === users[m].id
            );
            console.log(game);
            if (game) {
              let url = `/gamedetails.html?id=` + game.gameId;
              let pointText = "";
              let resultText = "-";
              if (game.gaming || game.ending) {
                const p = game.players;
                const mPlayer = p.find(e => e.id === users[m].id);
                const oPlayer = p.find(e => e.id === users[o].id);

                const mPoint = mPlayer.point.basepoint + mPlayer.point.wallpoint;
                const oPoint = oPlayer.point.basepoint + oPlayer.point.wallpoint;
                pointText = `${mPoint} - ${oPoint}`;
                if (mPoint > oPoint) resultText = "○";
                else if (mPoint < oPoint) resultText = "×";
                else resultText = "△";
              }
              return { pointText, resultText, url };
            } else return null;
          },
          gameCreate(m, o) {
            const users = this.tournament.users;
            const params = new URLSearchParams();
            params.append("name", `${this.tournament.name}:${users[m].screenName} vs ${users[o].screenName}`);
            params.append("n-player", 2);
            params.append("player1", users[m].name)
            params.append("player2", users[o].name);
            params.append("tournament-id", this.tournament.id);
            params.append("return", true);
            const url = `/game/create.html`
            location.href = "/game/create.html?" + params.toString();
            //console
            //console.log(m, o);
            //console.log(this.tournament.users[m].id)
          }
        }
      });

      async function get() {
        const query = util.getUrlQueries();
        const tournament = await getTournament(query.id);
        mainVue.update(tournament);
      }

      async function update(tournament) {
        mainVue.update(tournament);
      }

      get();

      const form = document.forms["add-user-form"];
      form.onsubmit = async (e) => {
        e.preventDefault();

        const userId = form["user-id"].value;
        console.log(userId);
        const tournament = await addTournamentUser(mainVue.tournament.id, userId);
        console.log(tournament);
        if (tournament.id) {
          mainVue.update(tournament);
          //await update(tournament);
        }
      }
      form["user-id"].oninput = async () => {
        const users = await searchUser(form["user-id"].value);
        console.log(users);
        mainVue.searchUserOptions = users;
      }


    </script>
    <script type="module" src="/js/vue-comp/common.js"></script>
  </body>

</html>

<style>
  @import url("/css/common.css");
  @import url("/css/c_form.css");
  @import url("/css/c_separation.css");

  #round-robin-table table,
  td,
  th {
    border: 1px solid;
  }

  form div input[type="submit"] {
    background-color: var(--codeforkosen-color);
    border: 1px solid var(--codeforkosen-color);
    margin-left: 1em;
    flex-grow: 0;
    padding-left: 1.5em;
    padding-right: 1.5em;
  }

  canvas {
    border: 1px solid;
  }
</style>